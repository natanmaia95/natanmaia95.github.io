<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Godot - making polygon colliders from AnimatedSprite2D | Natan Maia</title> <meta name="author" content="Natan Maia"> <meta name="description" content="Computer Science student and game developer. "> <meta name="keywords" content="jekyll, jekyll-theme, portfolio-website, game-development, gamedev"> <script type="application/ld+json">
    {
        "author":
        {
            "@type": "Person",
            "name": "Natan  Maia"
        },
        "url": "https://natanmaia95.github.io/blog/2024/animated-sprite-polygon-godot4/",
        "@type": "BlogPosting",
        "description": "Computer Science student and game developer.
",
        "headline": "Godot - making polygon colliders from AnimatedSprite2D",
        "sameAs": ["https://github.com/natanmaia95", "https://discord.com/users/341334925095469060", "https://nate-the-bard.itch.io"],
        "name": "Natan  Maia",
        "@context": "https://schema.org"
    }
    </script> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%8D%B0&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://natanmaia95.github.io/blog/2024/animated-sprite-polygon-godot4/"> <link rel="alternate" type="application/atom+xml" title="blank" href="/feed.xml"> </head> <body class="fixed-top-nav sticky-bottom-footer"> <div class="bodycontainer"> <header> <div id="navparent" class="navparent"> <nav id="navbar" class="navbar navbar-light navbar-expand-sm"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Natan </span>Maia</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> </ul> </div> </div> </nav> </div> </header> <div class="container mt-5 maincontainer"> <div class="post"> <header class="post-header"> <h1 class="post-title">Godot - making polygon colliders from AnimatedSprite2D</h1> <p class="post-meta">March 5, 2024</p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/code"> <i class="fa-solid fa-hashtag fa-sm"></i> code</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <div class="row mt-3"> <div class="col-2 mt-3 mt-md-0"></div> <div class="col-8 mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/posts/2024/poly_animsprite_fox1.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-2 mt-3 mt-md-0"></div> </div> <p>I made a little tool script that can generate polygon shapes for Area2D nodes for each frame of an AnimatedSprite2D, and make those areas active and inactive at runtime. It is based on a few assumptions, like your AnimatedSprite2D doesn’t use offsets and your AtlasTextures don’t use margins, but I’m sure those would be easy to add in if needed.</p> <p>The road to it was a bit bumpy, though. It has been a while since I made it so I don’t rememeber all the details but I still want to share my journey, as well as the tool’s code.</p> <h3 id="context">Context</h3> <p>In January I took some time off to learn a bit more about multiplayer games in Godot by making a fighting game (er, following a tutorial that is). Fighting games are pretty complex so a tutorial could be a good primer, and I already made some action games before so that knowledge could translate here too.</p> <p>I like Super Smash Bros so I was very inclined to follow <a href="https://www.youtube.com/watch?v=FKMBkZsPCCA&amp;list=PLeJDGeZe3by2tQIJmCZfaSRl95cot070t" rel="external nofollow noopener" target="_blank">this tutorial series by Apano</a>. There are a few design patterns I don’t totally agree with but it’s very serviceable. I promptly implemented everything and had fun with how smooth it felt. Just one problem: the tutorial used the character’s solid collision square box as the damage hurtbox, which meant it couldn’t quite reflect the different sprites. It also meant, for the game to be juicy, you had to exaggerate the attack hitboxes which would further highlight the problem.</p> <div class="row mt-3"> <div class="col-2 mt-3 mt-md-0"></div> <div class="col-8 mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/posts/2024/poly_animsprite_fox2.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-2 mt-3 mt-md-0"></div> </div> <p>Side note: I didn’t have a second controller to test multiplayer, but I’ve since learned Godot can recognize virtual controllers from <em>Parsec</em>. It has been my favorite way to test multiplayer games. I’m not being paid to say this (unfortunately) but it’s pretty cool.</p> <h3 id="research">Research</h3> <p>TheShaggyDev is one of my favorite Godot creators as he dives deep into his design process for code and project structure, and many of his projects align with my likes. I was delighted to know he had made a video on getting polygon shapes (for static colliders) from Sprite2D nodes.</p> <div class="embed-responsive embed-responsive-16by9"> <figure> <iframe src="https://www.youtube.com/embed/Btk8IzhvaDo?si=YIluHglNY37pbH3S" class="img-fluid rounded z-depth-1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="" width="auto" height="auto"></iframe> </figure> </div> <div class="caption">There's also a text version linked in the video's description.</div> <p>That’s cool and all, but how would I do that for every frame in an AnimatedSprite2D? I couldn’t generate the polygons at runtime as the algorithm is pretty slow, so I would need to generate one shape for each frame, then activate and deactivate them at runtime. I needed to make a tool script that would generate all my polygons when I ticked a checkbox (in the lack of tool script buttons).</p> <div class="language-gdscript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="nf">run_tool</span><span class="p">():</span>
	<span class="k">var</span> <span class="n">anim_sprite</span> <span class="p">:</span><span class="o">=</span> <span class="n">get_parent</span><span class="p">()</span> <span class="k">as</span> <span class="n">AnimatedSprite2D</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">anim_sprite</span><span class="p">:</span>
		<span class="n">push_error</span><span class="p">(</span><span class="s2">"Parent is not AnimatedSprite2D"</span><span class="p">)</span>
        <span class="k">return</span>

	<span class="n">hurtbox_dict</span> <span class="o">=</span> <span class="p">{}</span>
	
	<span class="k">var</span> <span class="n">bitmap</span> <span class="p">:</span> <span class="n">BitMap</span>
	<span class="k">var</span> <span class="n">current_texture</span> <span class="p">:</span> <span class="n">Texture2D</span>
	
	<span class="k">var</span> <span class="n">old_hurtboxes</span> <span class="o">=</span> <span class="n">get_parent</span><span class="p">()</span><span class="o">.</span><span class="n">get_parent</span><span class="p">()</span><span class="o">.</span><span class="n">get_node_or_null</span><span class="p">(</span><span class="s2">"Hurtboxes"</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">old_hurtboxes</span><span class="p">:</span>
		<span class="n">old_hurtboxes</span><span class="o">.</span><span class="n">queue_free</span><span class="p">()</span>
	
	<span class="k">var</span> <span class="n">results_node</span> <span class="p">:</span><span class="o">=</span> <span class="n">Node2D</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
	<span class="n">anim_sprite</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">results_node</span><span class="p">)</span>
	<span class="n">results_node</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">get_tree</span><span class="p">()</span><span class="o">.</span><span class="n">edited_scene_root</span>
	<span class="n">results_node</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Hurtboxes"</span>
	<span class="n">hurtboxes_path</span> <span class="o">=</span> <span class="n">get_path_to</span><span class="p">(</span><span class="n">results_node</span><span class="p">)</span>
</code></pre></div></div> <p>Now I just had to find the sprite’s texture as it was shown on the AnimatedSprite2D, and make polygons from that. How hard could it be? It’s probably right there in the documentation, right?</p> <h3 id="getting-the-frames-texture">Getting the frame’s texture.</h3> <p>Most of my frames were imported as AtlasTextures for brevity’s sake and to not bloat each character’s folder with a hundred files; if I had each frame separately I could probably used ShaggyDev’s aproach by using a simple Sprite2D and changing its frame to another file for each shape. Following that approach approach of getting the texture directly wouldn’t work with AnimatedSprite2D as there was no one single texture for the entire animation; each frame of each animation can have a texture taken from a separate file, or an atlas made from a file, or even a blank texture.</p> <p>For a long time I tried creating a new <em>viewport</em>, rendering the AnimatedSprite2D there, saving the <em>render texture</em> and using that, but in retrospect even if it worked, it wouldn’t have accounted for different sizes in sprite frames… I wish I had commited every single attempt just to look back on them, because I had some really absurd ideas. I’m not even sure if it every rendered anything, although I remember getting a polygon from an entirely unrelated section of the Atlas.</p> <p><i>Eventually, I found: Texture2D SpriteFrames.get_frame_texture(anim: StringName, idx: int). It’s in the documentation.</i></p> <p>So that was a relief. I just needed to make an image from it… wait, why is it blank? For whatever reason (and without breakpoints for tool scripts it took a whole morning to find out) the generated texture when converted to a bitmap wouldn’t show as a cut-up region of its AtlasTexture during the tool’s execution. It was entirely blank. I tied to print the “region” field but it was all 0,0. I couldn’t figure out why for another long period of time.</p> <div class="language-gdscript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">sprite_frames</span> <span class="p">:</span> <span class="n">SpriteFrames</span> <span class="o">=</span> <span class="n">anim_sprite</span><span class="o">.</span><span class="n">sprite_frames</span>
<span class="k">for</span> <span class="n">animation_name</span> <span class="ow">in</span> <span class="n">sprite_frames</span><span class="o">.</span><span class="n">get_animation_names</span><span class="p">():</span>
    <span class="n">anim_sprite</span><span class="o">.</span><span class="n">animation</span> <span class="o">=</span> <span class="n">animation_name</span>
    
    <span class="k">for</span> <span class="n">frame_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sprite_frames</span><span class="o">.</span><span class="n">get_frame_count</span><span class="p">(</span><span class="n">animation_name</span><span class="p">)):</span>
        <span class="n">anim_sprite</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame_index</span>
        
        <span class="n">bitmap</span> <span class="o">=</span> <span class="n">BitMap</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
        <span class="n">current_texture</span> <span class="o">=</span> <span class="n">sprite_frames</span><span class="o">.</span><span class="n">get_frame_texture</span><span class="p">(</span><span class="n">animation_name</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">)</span>
</code></pre></div></div> <p>My final solution was to get the atlas and make it into an image, as before. I finally found the AtlasTexture “region” field which this time had actual values in it. Then, the fruit of another half an hour of reading documentation I found code Image.get_region(Rect2Di region) and the region field in the atlas texture worked. Wheww. There’s also a tweak for if the source is an entire file or blank.</p> <div class="language-gdscript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># inside the inner for loop</span>
<span class="k">if</span> <span class="n">current_texture</span> <span class="k">is</span> <span class="n">AtlasTexture</span><span class="p">:</span>
    <span class="k">var</span> <span class="n">img</span> <span class="o">=</span> <span class="n">current_texture</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">get_image</span><span class="p">()</span><span class="o">.</span><span class="n">get_region</span><span class="p">(</span><span class="n">current_texture</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
    <span class="n">bitmap</span><span class="o">.</span><span class="n">create_from_image_alpha</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span> <span class="c1"># file or blank</span>
    <span class="n">bitmap</span><span class="o">.</span><span class="n">create_from_image_alpha</span><span class="p">(</span><span class="n">current_texture</span><span class="o">.</span><span class="n">get_image</span><span class="p">())</span>
</code></pre></div></div> <h3 id="finishing-the-tool">Finishing the tool</h3> <p>Now I just needed to generate the polygons. At first I wanted just one Area2D and one polygon per frame, but if the sprite had separate sections that wouldn’t add into a single shape they would be skipped. Instead, I have an Area2D for each frame, which can hold multiple polygons if needed. I’m also adding all the node references for each area into a dictionary to avoid excessive get_node calls.</p> <div class="language-gdscript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># inside the inner for loop as well</span>
<span class="k">var</span> <span class="n">polys</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">.</span><span class="n">opaque_to_polygons</span><span class="p">(</span><span class="n">Rect2i</span><span class="p">(</span><span class="kt">Vector2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">bitmap</span><span class="o">.</span><span class="n">get_size</span><span class="p">()),</span> <span class="n">epsilon</span><span class="p">)</span>

<span class="k">var</span> <span class="n">area</span> <span class="o">=</span> <span class="n">Area2D</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="n">results_node</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>
<span class="n">area</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">get_tree</span><span class="p">()</span><span class="o">.</span><span class="n">edited_scene_root</span>
<span class="n">area</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">_</span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="p">[</span><span class="n">animation_name</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">]</span>
<span class="n">hurtbox_dict</span><span class="p">[</span><span class="n">area</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_path_to</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>

<span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">polys</span><span class="p">:</span>
    <span class="k">var</span> <span class="n">collision_polygon</span> <span class="o">=</span> <span class="n">CollisionPolygon2D</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
    <span class="n">collision_polygon</span><span class="o">.</span><span class="n">polygon</span> <span class="o">=</span> <span class="n">poly</span>
    <span class="n">collision_polygon</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="o">-</span><span class="n">bitmap</span><span class="o">.</span><span class="n">get_size</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span> <span class="c1"># assume centered</span>
    <span class="n">collision_polygon</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="bp">true</span>
    <span class="n">collision_polygon</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="bp">false</span>
    <span class="n">area</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">collision_polygon</span><span class="p">)</span>
    <span class="n">collision_polygon</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">get_tree</span><span class="p">()</span><span class="o">.</span><span class="n">edited_scene_root</span>
</code></pre></div></div> <div class="row mt-3"> <div class="col-2 mt-3 mt-md-0"></div> <div class="col-8 mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/posts/2024/poly_animsprite_fox1.jpg" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-2 mt-3 mt-md-0"></div> </div> <div class="caption">Each area has a name matching an animation and a frame index.</div> <h3 id="updating-during-runtime">Updating during runtime</h3> <p>The helper node also has functions to be executed at runtime. Currently it waits for signals from the AnimatedSprite2D node, but I’m not sure if it introduces a physics frame of delay or not. Alternatively you could run update_shape inside _physics_process.</p> <div class="language-gdscript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="nf">update_shape</span><span class="p">():</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">hurtboxes_node</span><span class="p">:</span> <span class="k">return</span>
    <span class="c1"># disable everything</span>
	<span class="k">for</span> <span class="n">inactive_hurtbox</span> <span class="p">:</span> <span class="n">Area2D</span> <span class="ow">in</span> <span class="n">hurtboxes_node</span><span class="o">.</span><span class="n">get_children</span><span class="p">():</span>
		<span class="n">disable_area</span><span class="p">(</span><span class="n">inactive_hurtbox</span><span class="p">)</span>
    <span class="c1"># enable the active one searching the dict</span>
	<span class="k">var</span> <span class="n">active_hurtbox</span> <span class="o">=</span> <span class="n">get_node</span><span class="p">(</span><span class="n">hurtbox_dict</span><span class="p">[</span><span class="s2">"</span><span class="si">%s</span><span class="s2">_</span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="p">[</span><span class="n">current_animation</span><span class="p">,</span> <span class="n">current_frame</span><span class="p">]])</span>
	<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">active_hurtbox</span><span class="o">.</span><span class="n">get_children</span><span class="p">():</span>
		<span class="n">col</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="bp">false</span>
		<span class="n">col</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="bp">true</span>
	<span class="n">active_hurtbox</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="kt">Vector2</span><span class="p">(</span>
			<span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">animated_sprite</span><span class="o">.</span><span class="n">flip_h</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span> 
			<span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">animated_sprite</span><span class="o">.</span><span class="n">flip_v</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div> <h3 id="code">Code</h3> <p>Here’s the entire code for this tool. It is a Node2D that should be inserted as a child of the AnimatedSprite2D to animate, and it will handle changing the hurtboxes at runtime too.</p> <div class="language-gdscript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">@</span><span class="k">tool</span>
<span class="k">extends</span> <span class="n">Node2D</span>
<span class="c1">## poly_animsprite_helper.gd</span>


<span class="err">@</span><span class="k">export</span> <span class="k">var</span> <span class="n">epsilon</span> <span class="p">:</span> <span class="kt">float</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="err">@</span><span class="k">export</span> <span class="k">var</span> <span class="n">generate</span> <span class="p">:</span> <span class="kt">bool</span> <span class="o">=</span> <span class="bp">false</span> <span class="p">:</span>
	<span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">Engine</span><span class="o">.</span><span class="n">is_editor_hint</span><span class="p">():</span> <span class="n">run_tool</span><span class="p">()</span>
		<span class="n">generate</span> <span class="o">=</span> <span class="n">value</span>

<span class="err">@</span><span class="k">export</span> <span class="k">var</span> <span class="n">hurtbox_dict</span> <span class="p">:</span> <span class="kt">Dictionary</span> <span class="o">=</span> <span class="p">{}</span>
<span class="err">@</span><span class="k">export</span> <span class="k">var</span> <span class="n">hurtboxes_path</span> <span class="p">:</span> <span class="kt">NodePath</span>

<span class="k">var</span> <span class="n">current_animation</span> <span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s2">""</span>
<span class="k">var</span> <span class="n">current_frame</span> <span class="p">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">var</span> <span class="n">animated_sprite</span> <span class="p">:</span> <span class="n">AnimatedSprite2D</span>
<span class="k">var</span> <span class="n">hurtboxes_node</span> <span class="p">:</span> <span class="n">Node2D</span>


<span class="k">func</span> <span class="nf">_ready</span><span class="p">():</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">Engine</span><span class="o">.</span><span class="n">is_editor_hint</span><span class="p">():</span>
		<span class="n">animated_sprite</span> <span class="o">=</span> <span class="n">get_parent</span><span class="p">()</span>
		<span class="n">animated_sprite</span><span class="o">.</span><span class="n">animation_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">_on_animation_changed</span><span class="p">)</span>
		<span class="n">animated_sprite</span><span class="o">.</span><span class="n">frame_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">_on_frame_changed</span><span class="p">)</span>
		<span class="n">hurtboxes_node</span> <span class="o">=</span> <span class="n">get_node</span><span class="p">(</span><span class="n">hurtboxes_path</span><span class="p">)</span>


<span class="k">func</span> <span class="nf">_on_animation_changed</span><span class="p">():</span>
	<span class="n">current_animation</span> <span class="o">=</span> <span class="n">animated_sprite</span><span class="o">.</span><span class="n">animation</span>
	<span class="n">current_frame</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">update_shape</span><span class="p">()</span>


<span class="k">func</span> <span class="nf">_on_frame_changed</span><span class="p">():</span>
	<span class="n">current_frame</span> <span class="o">=</span> <span class="n">animated_sprite</span><span class="o">.</span><span class="n">frame</span>
	<span class="n">update_shape</span><span class="p">()</span>


<span class="k">func</span> <span class="nf">update_shape</span><span class="p">():</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">hurtboxes_node</span><span class="p">:</span> <span class="k">return</span>
	<span class="k">for</span> <span class="n">inactive_hurtbox</span> <span class="p">:</span> <span class="n">Area2D</span> <span class="ow">in</span> <span class="n">hurtboxes_node</span><span class="o">.</span><span class="n">get_children</span><span class="p">():</span>
		<span class="n">disable_area</span><span class="p">(</span><span class="n">inactive_hurtbox</span><span class="p">)</span>
	
	<span class="k">var</span> <span class="n">active_hurtbox</span> <span class="o">=</span> <span class="n">get_node</span><span class="p">(</span><span class="n">hurtbox_dict</span><span class="p">[</span><span class="s2">"</span><span class="si">%s</span><span class="s2">_</span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="p">[</span><span class="n">current_animation</span><span class="p">,</span> <span class="n">current_frame</span><span class="p">]])</span>
	<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">active_hurtbox</span><span class="o">.</span><span class="n">get_children</span><span class="p">():</span>
		<span class="n">col</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="bp">false</span>
		<span class="n">col</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="bp">true</span>
	<span class="n">active_hurtbox</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="kt">Vector2</span><span class="p">(</span>
			<span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">animated_sprite</span><span class="o">.</span><span class="n">flip_h</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span> 
			<span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">animated_sprite</span><span class="o">.</span><span class="n">flip_v</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>


<span class="k">func</span> <span class="nf">disable_area</span><span class="p">(</span><span class="n">area</span><span class="p">:</span><span class="n">Area2D</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">void</span><span class="p">:</span>
	<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">area</span><span class="o">.</span><span class="n">get_children</span><span class="p">():</span>
		<span class="n">col</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="bp">true</span>
		<span class="n">col</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="bp">false</span>


<span class="k">func</span> <span class="nf">run_tool</span><span class="p">():</span>
	<span class="k">var</span> <span class="n">anim_sprite</span> <span class="p">:</span><span class="o">=</span> <span class="n">get_parent</span><span class="p">()</span> <span class="k">as</span> <span class="n">AnimatedSprite2D</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">anim_sprite</span><span class="p">:</span>
		<span class="n">push_error</span><span class="p">(</span><span class="s2">"Parent is not AnimatedSprite2D"</span><span class="p">)</span>
		<span class="k">return</span>
	
	<span class="n">hurtbox_dict</span> <span class="o">=</span> <span class="p">{}</span>
	
	<span class="k">var</span> <span class="n">bitmap</span> <span class="p">:</span> <span class="n">BitMap</span>
	<span class="k">var</span> <span class="n">current_texture</span> <span class="p">:</span> <span class="n">Texture2D</span>
	
	<span class="k">var</span> <span class="n">old_hurtboxes</span> <span class="o">=</span> <span class="n">get_parent</span><span class="p">()</span><span class="o">.</span><span class="n">get_parent</span><span class="p">()</span><span class="o">.</span><span class="n">get_node_or_null</span><span class="p">(</span><span class="s2">"Hurtboxes"</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">old_hurtboxes</span><span class="p">:</span>
		<span class="n">old_hurtboxes</span><span class="o">.</span><span class="n">queue_free</span><span class="p">()</span>
	
	<span class="k">var</span> <span class="n">results_node</span> <span class="p">:</span><span class="o">=</span> <span class="n">Node2D</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
	<span class="n">anim_sprite</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">results_node</span><span class="p">)</span>
	<span class="n">results_node</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">get_tree</span><span class="p">()</span><span class="o">.</span><span class="n">edited_scene_root</span>
	<span class="n">results_node</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Hurtboxes"</span>
	<span class="n">hurtboxes_path</span> <span class="o">=</span> <span class="n">get_path_to</span><span class="p">(</span><span class="n">results_node</span><span class="p">)</span>
	
	<span class="k">var</span> <span class="n">sprite_frames</span> <span class="p">:</span> <span class="n">SpriteFrames</span> <span class="o">=</span> <span class="n">anim_sprite</span><span class="o">.</span><span class="n">sprite_frames</span>
	<span class="k">for</span> <span class="n">animation_name</span> <span class="ow">in</span> <span class="n">sprite_frames</span><span class="o">.</span><span class="n">get_animation_names</span><span class="p">():</span>
		<span class="n">anim_sprite</span><span class="o">.</span><span class="n">animation</span> <span class="o">=</span> <span class="n">animation_name</span>
		
		<span class="k">for</span> <span class="n">frame_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sprite_frames</span><span class="o">.</span><span class="n">get_frame_count</span><span class="p">(</span><span class="n">animation_name</span><span class="p">)):</span>
			<span class="n">anim_sprite</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame_index</span>
			
			<span class="n">bitmap</span> <span class="o">=</span> <span class="n">BitMap</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
			<span class="n">current_texture</span> <span class="o">=</span> <span class="n">sprite_frames</span><span class="o">.</span><span class="n">get_frame_texture</span><span class="p">(</span><span class="n">animation_name</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">)</span>
			
			<span class="k">if</span> <span class="n">current_texture</span> <span class="k">is</span> <span class="n">AtlasTexture</span><span class="p">:</span>
				<span class="k">var</span> <span class="n">img</span> <span class="o">=</span> <span class="n">current_texture</span><span class="o">.</span><span class="n">atlas</span><span class="o">.</span><span class="n">get_image</span><span class="p">()</span><span class="o">.</span><span class="n">get_region</span><span class="p">(</span><span class="n">current_texture</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
				<span class="n">bitmap</span><span class="o">.</span><span class="n">create_from_image_alpha</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">bitmap</span><span class="o">.</span><span class="n">create_from_image_alpha</span><span class="p">(</span><span class="n">current_texture</span><span class="o">.</span><span class="n">get_image</span><span class="p">())</span>
			
			
			<span class="k">var</span> <span class="n">polys</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">.</span><span class="n">opaque_to_polygons</span><span class="p">(</span><span class="n">Rect2i</span><span class="p">(</span><span class="kt">Vector2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">bitmap</span><span class="o">.</span><span class="n">get_size</span><span class="p">()),</span> <span class="n">epsilon</span><span class="p">)</span>
			<span class="nb">print</span><span class="p">(</span><span class="n">animation_name</span><span class="p">,</span> <span class="s2">"_"</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">,</span> <span class="s2">" "</span><span class="p">,</span> <span class="n">polys</span><span class="p">)</span>
			
			<span class="k">var</span> <span class="n">area</span> <span class="o">=</span> <span class="n">Area2D</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
			<span class="n">results_node</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>
			<span class="n">area</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">get_tree</span><span class="p">()</span><span class="o">.</span><span class="n">edited_scene_root</span>
			<span class="n">area</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">_</span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="p">[</span><span class="n">animation_name</span><span class="p">,</span> <span class="n">frame_index</span><span class="p">]</span>
			<span class="n">hurtbox_dict</span><span class="p">[</span><span class="n">area</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_path_to</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>
			
			<span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">polys</span><span class="p">:</span>
				<span class="k">var</span> <span class="n">collision_polygon</span> <span class="o">=</span> <span class="n">CollisionPolygon2D</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
				<span class="n">collision_polygon</span><span class="o">.</span><span class="n">polygon</span> <span class="o">=</span> <span class="n">poly</span>
				<span class="n">collision_polygon</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="o">-</span><span class="n">bitmap</span><span class="o">.</span><span class="n">get_size</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span>
				<span class="n">collision_polygon</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="bp">true</span>
				<span class="n">collision_polygon</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="bp">false</span>
				<span class="n">area</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">collision_polygon</span><span class="p">)</span>
				<span class="n">collision_polygon</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">get_tree</span><span class="p">()</span><span class="o">.</span><span class="n">edited_scene_root</span>
</code></pre></div></div> </div> </article> </div> </div> <footer class="sticky-bottom mt-5"> <div class="container"> © Copyright 2025 Natan Maia. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: January 16, 2025. </div> </footer> </div> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?07b8786bab9b4abe90d10e61f7d12ff7" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> </body> </html>